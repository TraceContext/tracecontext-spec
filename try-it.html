<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
 
    <title>Trace Context</title>
 
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" integrity="sha384-Zug+QiDoJOrZ5t4lssLdxGhVrurbmBWopoEl+M6BdEfwnCJZtKxi1KgxUyJq13dy" crossorigin="anonymous">
</head>
<body>
    <div class="container">
        <h1>Trace Context Demo</h1>

        <p>
            Trace Context consists of two http headers. Each header represent a semantically different set of fields. Required id fields in traceparent, extended tracing fields in tracestate.
        </p>

        <div id="root"></div>
    </div>
       
    <!--bootstrap-->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js" integrity="sha384-a5N7Y/aK3qNeh15eJKGWxsqtnX/wWdSZSKp+81YjTmS15nvnvxKHuzaWwXHDli+4" crossorigin="anonymous"></script>
 
    <!--react-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script type="text/babel">
 
        class TraceContextForm extends React.Component {
            constructor(props) {
                super(props);
 
                this.state = {
                    // global state. fields that can be set
                    g: {
                        traceparent: "00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-00",
                        tracestate: "tc",
                        m: [
                        ]
                    },

                    // temporary variables to allow to add new name/value pairs in collecitons
                    newExtProp: {name: "cluster-id", value: "3563577b34"},
                    
                    // calculated fields
                    calculated: {
                        success: true,
                        errorMessage: "",
                        m:[
                            {
                                traceparent: '',
                                tracestate: '',
                                success: true,
                                errorMessage: "",
                            }
                        ]
                    },
                };

                // parse out global state from the URL. This allows to share examples
                var hash = window.location.hash;
                if (hash != "") {
                    hash = decodeURI(hash.substring(1));
                    this.state.g = JSON.parse(hash);
                }

                this.updateHeaders(this.state);
            }

            getRandom16charsString() {
                var result = "";
                for (var i = 0; i < 4; i++) {
                    result += Math.floor(Math.random() * 65536).toString(16);
                }

                while (result.length < 16) {
                    result = "0" + result;
                }

                return result;
            }


            getTraceParent(args, result) {
                // =====================================================
                // Calculate traceparent header
                //
                if (args.traceId.length != 32) {
                    result.success = false;
                    result.errorMessage += "\ntrace-id should be 32 characters long";
                }

                if (!args.traceId.match("^[0-9a-f]*$")) {
                    result.success = false;
                    result.errorMessage += "\ntrace-id should only contain lowercase hex characters";
                }

                if (args.spanId.length != 16) {
                    result.success = false;
                    result.errorMessage += "\nspan-id should be 16 characters long";
                }

                if (!args.spanId.match("^[0-9a-f]*$")) {
                    result.success = false;
                    result.errorMessage += "\nspan-id should only contain lowercase hex characters";
                }

                return "00-" + args.traceId + "-" + args.spanId + "-" + (args.sampled ? "01" : "00");
            }

            getTraceState(args, result) {
                result.tracestate = "";
                args.ext.forEach(element => {
                    var value = element.name + (element.value.length > 0 ?  "=" + element.value : "") + ",";

                    result.tracestate += value == "=," ? "" : value;
                });

                var tracestate = result.tracestate.substring(0, result.tracestate.length - 1);

                if (result.tracestate.length > 512) {
                    result.success = false;
                    result.errorMessage += "\ntracestate header maximum length should be less than 512 characters";
                }

                return tracestate;
            }


            getTraceContext(initialTraceContext, type, args, result) {
                result.success = true;
                result.errorMessage = "";
                result.traceparent = "";
                result.tracestate = "";

                var traceId = initialTraceContext.traceId;
                var spanId = initialTraceContext.spanId;
                var sampled = initialTraceContext.sampled;
                var ext = initialTraceContext.ext;
                initialTraceContext = {};

                if (type == "restart") {
                    initialTraceContext.traceId = args.traceId;
                    initialTraceContext.spanId = args.spanId;
                    initialTraceContext.sampled = args.sampled;
                    initialTraceContext.ext = args.ext;
                } else if (type == "next step") {
                    initialTraceContext.traceId = traceId;
                    initialTraceContext.spanId = args.spanId;
                    initialTraceContext.sampled = sampled;
                    initialTraceContext.ext = ext;
                }

                result.traceparent = this.getTraceParent(initialTraceContext, result);
                initialTraceContext.traceparent = result.traceparent;

                result.tracestate = this.getTraceState(initialTraceContext, result);
                initialTraceContext.tracestate = result.tracestate;

                return initialTraceContext;
            }

            parseTrtaceContext(args, result) {
                result.success = true;
                result.errorMessage = "";
                result.traceparent = "";
                result.tracestate = "";

                var initialTraceContext = {};

                
                var str = args.traceparent;
                str = str.substring(str.indexOf("-") + 1);
                //TODO: validate version
                
                var traceId = str.substring(0, str.indexOf("-"));
                str = str.substring(str.indexOf("-") + 1);

                var spanId = str.substring(0, str.indexOf("-"));
                str = str.substring(str.indexOf("-") + 1);

                var sampled = false;
                if (str != "00") {
                    sampled = true;
                }


                var str = args.tracestate;
                var ext = [];
                while (str.length > 0) {
                    var pair = str.indexOf(",") > 0 ? str.substring(0, str.indexOf(",")) : str;
                    if (pair.trim().length > 0) {
                        var idx = str.indexOf("=");
                        var name = idx > 0 ? pair.substring(0, idx) : pair;
                        var value = idx > 0 ? pair.substring(idx + 1) : "";
                        ext.push( {name: name, value: value} );
                    }

                    str = str.indexOf(",") > 0 ? str.substring(str.indexOf(",") + 1) : "";
                }
                

                initialTraceContext.traceId = traceId;
                initialTraceContext.spanId = spanId;
                initialTraceContext.sampled = sampled;
                initialTraceContext.ext = ext;

                result.traceparent = args.traceparent;
                initialTraceContext.traceparent = result.traceparent;

                result.tracestate = args.tracestate;
                initialTraceContext.tracestate = result.tracestate;

                return initialTraceContext;
            }

            // =====================================================
            // This is the main part of the file. Validation of fields and calculating of resulting headers happens here
            //
 
            updateHeaders(state) {
                if (state.calculated === undefined) {
                    state.calculated = {m:[]};
                }

                var initialTraceContext = this.parseTrtaceContext(state.g, state.calculated);

                var modifications = state.g.m;
                for (var i = 0; i < modifications.length; i++) {
                    state.calculated.m.push({});
                    initialTraceContext = this.getTraceContext(initialTraceContext, modifications[i].type, modifications[i].args, state.calculated.m[i]);
                }

                // Update URL so it can be shared as an example
                window.location.hash = encodeURI(JSON.stringify(state.g));
                return state;
            }

            handleTraceParentChange(event) {
                var traceparent = event.target.value;
                this.setState((state) => {state.g.traceparent = traceparent; return this.updateHeaders(state);});
            }

            handleTraceStateChange(event) {
                var tracestate = event.target.value;
                this.setState((state) => {state.g.tracestate = tracestate; return this.updateHeaders(state);});
            }
 
            handleTraceIdChange(index) {
                return (event) => 
                {
                    var traceId = event.target.value;
                    this.setState((state) => {state.g.m[index].args.traceId = traceId; return this.updateHeaders(state);});
                }
            }
 
            handleSpanIdChange(index) {
                return (event) => {
                    var spanId = event.target.value;
                    this.setState((state) => {state.g.m[index].args.spanId = spanId; return this.updateHeaders(state);});
                }
            }

            handleSampledChange(index) {
                return (event) => {
                    var sampled = event.target.checked;
                    this.setState((state) => {state.g.m[index].args.sampled = sampled; return this.updateHeaders(state);});
                }
            }

            handleChangeExtPropName(index, extIdx) {
                return (event) =>
                {
                    var extPropName = event.target.value;
                    this.setState((state) => {state.g.m[index].args.ext[extIdx].name = extPropName; return this.updateHeaders(state);});
                }
            }
 
            handleChangeExtPropValue(index, extIdx) {
                return (event) =>
                {
                    var extPropValue = event.target.value;
                    this.setState((state) => {state.g.m[index].args.ext[extIdx].value = extPropValue; return this.updateHeaders(state);});
                }
            }

            handleNewExtPropName(event) {
                var newExtPropName = event.target.value;
                this.setState((state) => {state.newExtProp.name = newExtPropName; return this.updateHeaders(state);});
            }
           
            handleNewExtPropValue(event) {
                var newExtPropValue = event.target.value;
                this.setState((state) => {state.newExtProp.value = newExtPropValue; return this.updateHeaders(state);});
            }
        
            addExtProp(index) {
                return (event) => {
                    this.setState((state) => {
                        state.g.m[index].args.ext.push(state.newExtProp);
                        state.newExtProp = {name: "", value: ""};
                        return this.updateHeaders(state);
                    });
                }
            }

            removeExtProp(index, extIdx) {
                return (event) =>
                {
                    this.setState((state) => {state.g.m[index].args.ext.splice(extIdx, 1); return this.updateHeaders(state);});
                }
            }

            handleAddModificationProp(type) {
                return (event) => {
                    this.setState((state) => {
                        if (type == "restart") {
                            state.g.m.push({
                                type: "restart", 
                                args: {
                                    traceId: this.getRandom16charsString() + this.getRandom16charsString(),
                                    spanId: this.getRandom16charsString(),
                                    sampled: false,
                                    ext: [
                                    ],
                                }
                            });
                        } else if (type == "next step") {
                            state.g.m.push({
                                type: "next step", 
                                args: {
                                    spanId: this.getRandom16charsString(),
                                }
                            });
                        }
                        return this.updateHeaders(state);
                    });
                }
            }

            getTraceStateProps(index) {
                var result = this.state.g.m[index].args.ext.map((prop, extIdx) =>
                    <li key={"ext_" + extIdx}>
                        <label> Name: <input key={"ext_" + extIdx + "_name"} type="text" className="form-control" value={this.state.g.m[index].args.ext[extIdx].name} onChange={this.handleChangeExtPropName(index, extIdx).bind(this)} /></label>
                        <label> Value: <input key={"ext_" + extIdx + "_value"} type="text" className="form-control" value={this.state.g.m[index].args.ext[extIdx].value} onChange={this.handleChangeExtPropValue(index, extIdx).bind(this)} /></label>
                        <a href="#" onClick={this.removeExtProp(index, extIdx).bind(this)} key={"remove_" + extIdx}>
                            <span className="glyphicon glyphicon-remove" /> Remove
                        </a>
                    </li>
                );
                return result;
            }

            getTraceStatePropsNew(index) {
                return (<div className="row">
                                <div className="col-md-1">
                                    Name
                                </div>
                                <div className="col">
                                    <input key={"ext_new_name"} className="form-control" placeholder="name" type="text" value={this.state.newExtProp.name} onChange={this.handleNewExtPropName.bind(this)} />
                                </div>
                                <div className="col-md-1">
                                    Value
                                </div>
                                <div className="col">
                                    <input key={"ext_new_value"} className="form-control" placeholder="value" type="text" value={this.state.newExtProp.value} onChange={this.handleNewExtPropValue.bind(this)} />
                                </div>
                                <div className="col">
                                    <a href="#" key="new_ext" onClick={this.addExtProp(index).bind(this)}>Add</a>
                                </div>
                            </div>);
            }

            getModifications() {
                return this.state.g.m.map((prop, index) => {
                    if (this.state.g.m[index].type == "restart") {
                        return (<div className="card">
                    <div className="card-body">
                        <h3 className="card-title">Modification: "restart trace"</h3>
                        
                        <div className="card">
                            <div className="card-body">
                                <h4 className="card-title">Trace parent</h4>
                                <div className="row">
                                    <div className="col-md-1">
                                        trace-id
                                    </div>
                                    <div className="col">
                                        <input type="text" id="trace-id" className="form-control" placeholder="00000000000000000000000000000000" value={this.state.g.m[index].args.traceId} onChange={this.handleTraceIdChange(index).bind(this)} />
                                    </div>
                                </div>
                                <div className="row">
                                    <div className="col-md-1">
                                        span-id
                                    </div>
                                    <div className="col">
                                        <input type="text" className="form-control" placeholder="00000000000000" value={this.state.g.m[index].args.spanId} onChange={this.handleSpanIdChange(index).bind(this)} /> 
                                    </div>
                                </div>
                                <div className="row">
                                    <div className="col-md-1">
                                        sampled
                                    </div>
                                    <div className="col">
                                        <input type="checkbox" className="form-check-input" value={this.state.g.m[index].args.sampled} onChange={this.handleSampledChange(index).bind(this)} /> 
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="card">
                            <div className="card-body">
                                <h4 className="card-title">Trace state</h4>

                                <ul>
                                    {this.getTraceStateProps(index)}
                                </ul>
                                {this.getTraceStatePropsNew(index)}
                            </div>
                        </div>
                    </div>
                    <div className={this.state.calculated.m[index].success ? "alert alert-success" : "alert alert-danger"} role="alert">
                        <p style={{display: this.state.calculated.m[index].errorMessage.length != 0 ? 'block' : 'none' }}>Errors: {this.state.calculated.m[index].errorMessage}</p>

                        <h4 className="alert-heading">Headers:</h4>
                        <p>traceparent: {this.state.calculated.m[index].traceparent}</p>
                        <p style={{display: this.state.calculated.m[index].tracestate.length != 0 ? 'block' : 'none' }}>tracestate: {this.state.calculated.m[index].tracestate}</p>
                    </div>
                </div>)

                    } else if (this.state.g.m[index].type == "next step") {
                        return (<div className="card">
                    <div className="card-body">
                        <h3 className="card-title">Modification: next step</h3>
                        
                        <div className="card">
                            <div className="card-body">
                                <div className="row">
                                    <div className="col-md-1">
                                        span-id
                                    </div>
                                    <div className="col">
                                        <input type="text" className="form-control" placeholder="00000000000000" value={this.state.g.m[index].args.spanId} onChange={this.handleSpanIdChange(index).bind(this)} /> 
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div className={this.state.calculated.m[index].success ? "alert alert-success" : "alert alert-danger"} role="alert">
                        <p style={{display: this.state.calculated.m[index].errorMessage.length != 0 ? 'block' : 'none' }}>Errors: {this.state.calculated.m[index].errorMessage}</p>

                        <h4 className="alert-heading">Headers:</h4>
                        <p>traceparent: {this.state.calculated.m[index].traceparent}</p>
                        <p style={{display: this.state.calculated.m[index].tracestate.length != 0 ? 'block' : 'none' }}>tracestate: {this.state.calculated.m[index].tracestate}</p>
                    </div>
                </div>)

                    }
                    
                    });
            }

            render() {
                return (
                    <form onSubmit = {this.handleSubmit}>

                        <div className={this.state.calculated.success ? "alert alert-success" : "alert alert-danger"} role="alert">
                            <p style={{display: this.state.calculated.errorMessage.length != 0 ? 'block' : 'none' }}>Errors: {this.state.calculated.errorMessage}</p>

                            <h4 className="alert-heading">Headers:</h4>
                            <p>traceparent:
                                    <div className="col">
                                        <input type="text" id="traceparent" className="form-control" placeholder="00-00000000000000000000000000000000-00000000000000-00" value={this.state.g.traceparent} onChange={this.handleTraceParentChange.bind(this)} />
                                    </div>
                            </p>
                            <p>tracestate: 
                                <div className="col">
                                        <input type="text" id="tracestate" className="form-control" placeholder="tc" value={this.state.g.tracestate} onChange={this.handleTraceStateChange.bind(this)} />
                                    </div>
                            </p>
                        </div>
                        {this.getModifications()}

                        <button type="button" class="btn btn-primary" onClick={this.handleAddModificationProp("next step").bind(this)}>next step</button>
                        <button type="button" class="btn btn-primary" onClick={this.handleAddModificationProp("restart").bind(this)}>restart</button>
                    
                    </form>
                );
            }
        }
       
        ReactDOM.render(
            <TraceContextForm />,
            document.getElementById('root')
        );
    </script>
</body>
 
</html>



 